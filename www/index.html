<!DOCTYPE html>
<html>
<head>
	<!-- WARNING: for iOS 7, remove the width=device-width and height=device-height attributes. See https://issues.apache.org/jira/browse/CB-4323 -->
	<link rel="stylesheet" href="css/jquery.mobile-1.4.1.min.css" />
	<script src="js/jquery-1.11.0.min.js"></script>
	<script src="js/jquery.mobile-1.4.1.min.js"></script>
	
	<link rel="stylesheet" href="css/themes/ccn20.min.css" />
	<link rel="stylesheet" href="css/themes/jquery.mobile.icons.min.css" />
	
	<script src="js/highcharts.js"></script>
	<link rel="stylesheet" href="css/leaflet.css" />
	<link rel="stylesheet" href="css/leaflet.usermarker.css" />
	<link rel="stylesheet" href="css/vetrina.css" />
	<script src="js/leaflet.js"></script>
	<script src="js/leaflet.usermarker.js"></script>
	<script src="js/function_checkConnection.js"></script>
	<script src="barcodescanner.js"></script>
	<script type="text/javascript" src="cordova.js"></script>

	<title>QRcode</title>
</head>
<body>

<!-- Start of page: #vetrinaMappa -->
<div data-role="page" id="vetrinaMappa">

	<div data-role="header">
		<h1>Vetrina</h1>
	</div><!-- /header -->

	<div role="main" class="ui-content" >
		
	
	<script type="text/javascript" charset="utf-8">
	
	$( document ).on( "pageshow", "#vetrinaMappa", function() {
	
		var scanner = cordova.require("cordova/plugin/BarcodeScanner");
		var idEsercizio;
		var jsonVetrina;
		
		scanner.scan( function (result) {
		
		var url = result.text;
		alert(result.text);
		var match = url.match(/it\/content\/(\d+)/);
		if (match) {
			idEsercizio = match[1];
			alert(idEsercizio);
			/*
			$.ajax({
				alert(idEsercizio);
				url: "js/"+idEsercizio+".js",
				dataType: 'json',
				async: false,
				success: function(data) {
				jsonVetrina = data;
				sessionStorage.setItem('jsonVetrina', JSON.stringify(jsonVetrina));
				}
			}); // AJAX END
			*/
		} // END MATCH
		
        },function (error) { 
            console.log("Scanning failed: ", error); 
        }); //END SCANNER
		
		});
	// /PAGESHOW
	/*
	// NOME ESERCIZIO + INDIRIZZO + DESCRIZIONE
	
		var esercizioLatitude;
		var esercizioLongitude;
		var nomeParcheggioMappa;
		var parcheggioLatitude;
		var parcheggioLongitude;
		var nomeEsercizioMappa;
		alert(jsonVetrina);
		$.each(jsonVetrina, function(index, info) {
				
				$("h3.nomeEsercizio").html(info.NomeEsercizio);
				$(".indirizzoEsercizio").html(info.Indirizzo+" "+info.Citta);
				$(".descrizioneEsercizio").html(info.Descrizione);
				$(".nomeParcheggio").html(""+info.Parcheggio.nomeParcheggio+" "+info.Parcheggio.indirizzoParcheggio+"");
				
				esercizioLatitude = info.Latitudine;
				esercizioLongitude = info.Longitudine;
				nomeEsercizioMappa = info.NomeEsercizio;
				nomeParcheggioMappa = info.Parcheggio.nomeParcheggio;
				parcheggioLatitude = info.Parcheggio.latitudineParcheggio;
				parcheggioLongitude = info.Parcheggio.longitudineParcheggio;
	
		});
		
		
	// /NOME ESERCIZIO + INDIRIZZO + DESCRIZIONE
	
	// MAPPA + POSIZIONE UTENTE
	
	var map = new L.Map('map');
	
	var osmUrl='http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
	L.tileLayer(osmUrl, {minZoom: 8, maxZoom: 18}).addTo(map);
	
	var controlloZoom = L.control({ position: 'bottomleft' });

	controlloZoom.onAdd = function (map) {
		this._div = L.DomUtil.create('div', 'controlloZoom');
		this._div.innerHTML = '<button class="groupMarker">Fit to group marker</button><button class="userMarker">Fit to user marker</button>';
		return this._div;
	};

	controlloZoom.addTo(map);
	
	/*
	L.tileLayer('img/como/{z}/{x}/{y}.png', {
		maxZoom: 18
	}).addTo(map);
	
	var userLatitude;
	var userLongitude;
	var markerUtente;
	var markerEsercizio;
	var group;
	var watchID = null;
	var options = { maximumAge: 5000, timeout: 30000, enableHighAccuracy: true };
      
	watchID = navigator.geolocation.watchPosition(onSuccess, onError, options);
	
	var parkingIcon = L.icon({
		iconUrl: 'img/parking.png',
		iconSize:     [32, 37], // size of the icon
		popupAnchor:  [0, -20] // point from which the popup should open relative to the iconAnchor
	});
	
	var markerIcon = L.icon({
		iconUrl: 'img/marker-icon.png',
		iconSize:     [25, 41], // size of the icon
		popupAnchor:  [0, -20] // point from which the popup should open relative to the iconAnchor
	});
		
	
	markerEsercizio = L.marker([esercizioLatitude, esercizioLongitude], {icon: markerIcon}).addTo(map).bindPopup(nomeEsercizioMappa);
	//var markerParcheggio = L.marker([esercizioLatitude, esercizioLongitude], {icon: parkingIcon}).addTo(map).bindPopup(nomeParcheggioMappa);
	
	
	function onSuccess(position) {
	 		
	userLatitude = position.coords.latitude;
	userLongitude = position.coords.longitude;
	var userAccuracy = position.coords.accuracy 

	if (!markerUtente) {
	markerUtente = L.userMarker([userLatitude, userLongitude],{pulsing:true}).bindPopup("Sei qui.").addTo(map);
	markerUtente.setAccuracy(userAccuracy);
	map.setView(new L.LatLng(userLatitude, userLongitude),16);
	//group = new L.featureGroup([markerEsercizio, markerUtente]);
	}
	markerUtente.setLatLng([userLatitude, userLongitude],{pulsing:true}).update();
		
	
	
	//group = new L.featureGroup([markerEsercizio, markerUtente]);

	//map.fitBounds(group.getBounds().pad(0.25));
	
	} // FINE ON SUCCESS
	
	function onError(error) {
        //alert('code: '    + error.code    + '\n' + 'message: ' + error.message + '\n');
	}

	// /MAPPA + POSIZIONE UTENTE
	
	$(document).on("click", 'button.groupMarker', function(){
		group = new L.featureGroup([markerEsercizio, markerUtente]);
		map.fitBounds(group.getBounds().pad(0.25));
	});
	
	$(document).on("click", 'button.userMarker', function(){
		map.setView(new L.LatLng(userLatitude, userLongitude),16);
	});
	
	});
	// /PAGESHOW
	
	$(document).on("click", 'a.directions', function(){
		directions(esercizioLatitude, esercizioLongitude);
	});
		
	// FUNZIONE DIRECTIONS
	
	function directions(esercizioLatitude, esercizioLongitude) {
		var latLongDirections = ""+esercizioLatitude+","+esercizioLongitude+"";
		$(".directions").click(function(){
		navigator.google_navigate.navigate(latLongDirections, function() {
			console.log('Success');
		}, function(errMsg) {
			console.log("Failed: " + errMsg);
		});
		});
	}
	
	// /FUNZIONE DIRECTIONS
	
	*/
	</script>
	
	<!-- NOME ESERCIZIO -->
	
	<div id="box-nomeEsercizio">
	<h3 class="nomeEsercizio"></h3>
	</div>
	
	<!-- /NOME ESERCIZIO -->
	
	<!-- MAPPA + INDIRIZZO + DIRECTIONS + PANORAMICA + DISTANZA -->
	<div id="map" style="width: 1920px; height:400px"></div>
	<ul class="funzionalitaMappa">
	<li class="singolaFunzionalitaMappa indirizzoEsercizio"></li>
	<li class="singolaFunzionalitaMappa"><a href="#" class="directions">Navigazione</a></li>
	<li class="singolaFunzionalitaMappa">Distance</li>
	</ul>
	<!-- /MAPPA + INDIRIZZO + DIRECTIONS + PANORAMICA + DISTANZA -->
	
	<!-- DESCRIZIONE ESERCIZIO -->
	
	<div id="box-descrizioneEsercizio">
	<p class="descrizioneEsercizio"></p>
	</div>
	<!-- /DESCRIZIONE ESERCIZIO -->
	
	<!-- PARCHEGGIO VICINO ESERCIZIO -->
	
	<ul class="parcheggioVicino">
	<li class="immagineParcheggio"><img class="imgParcheggio" src="img/parcheggioVicino.png" style="width: 37px; height: 50px;"><p class="nomeParcheggio"></p></li>
	</ul>
	<!-- /PARCHEGGIO VICINO ESERCIZIO -->
		
	</div><!-- /content -->

	<div data-role="footer" data-theme="a" data-position="fixed">
		<div data-role="navbar" data-iconpos="top">
            <ul>
                <li><a href="#vetrinaMappa" data-transition="slide" data-icon="location">Mappa</a></li>
                <li><a href="#vetrinaOrari" data-transition="slide" data-icon="clock">Orari</a></li>
                <li><a href="#vetrinaContatti" data-transition="slide" data-icon="phone">Contatti</a></li>
				<li><a href="#vetrinaStatistiche" data-transition="slide" data-icon="gear">Statistiche</a></li>
				<!-- <li><a href="#" data-icon="camera">Gallery</a></li> -->
            </ul>
        </div><!-- /navbar -->
	</div><!-- /footer -->
</div><!-- /page vetrinaMappa -->




</body>
</html>
